<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purple Cow Admin Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slideIn {
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-purple-600 mx-auto mb-4"></div>
                <p class="text-gray-600 text-lg">Loading Admin Portal...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, get, set, push, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBmIjCVpaLoftPQv2nPz99PmAoJ3gD-0Gs",
            authDomain: "purple-cow-laundry.firebaseapp.com",
            databaseURL: "https://purple-cow-laundry-default-rtdb.firebaseio.com",
            projectId: "purple-cow-laundry",
            storageBucket: "purple-cow-laundry.firebasestorage.app",
            messagingSenderId: "1008755441028",
            appId: "1:1008755441028:web:0ea44309728e02c437b1d1",
            measurementId: "G-89RSJRV9DF"
        };

        let database;
        let currentView = 'dashboard';
        let customers = [];
        let selectedCustomer = null;
        let stats = { total: 0, pending: 0, pickedUp: 0, delivered: 0 };

        // Form states
        let newCustomer = { name: '', phone: '', address: '' };
        let newWash = { washNumber: '', pickupDate: '', deliveryDate: '', pickupCode: '', deliveryCode: '', status: 'pending' };

        try {
            const app = initializeApp(firebaseConfig);
            database = getDatabase(app);
            console.log('Firebase initialized');
            await loadData();
            render();
        } catch (err) {
            console.error('Firebase error:', err);
            document.getElementById('app').innerHTML = `
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="bg-red-50 border border-red-200 text-red-700 px-8 py-6 rounded-xl max-w-md">
                        <p class="text-xl font-bold mb-2">‚ö†Ô∏è Connection Error</p>
                        <p>Failed to connect to database.</p>
                    </div>
                </div>
            `;
        }

        async function loadData() {
            try {
                const snapshot = await get(ref(database, 'customers'));
                const data = snapshot.val();
                
                if (data) {
                    customers = Object.entries(data).map(([id, customer]) => ({
                        id,
                        ...customer,
                        washes: customer.washes || []
                    }));
                    calculateStats();
                }
            } catch (err) {
                console.error('Error loading data:', err);
            }
        }

        function calculateStats() {
            stats = { total: 0, pending: 0, pickedUp: 0, delivered: 0 };
            customers.forEach(customer => {
                customer.washes.forEach(wash => {
                    stats.total++;
                    if (wash.status === 'pending') stats.pending++;
                    else if (wash.status === 'picked-up') stats.pickedUp++;
                    else if (wash.status === 'delivered') stats.delivered++;
                });
            });
        }

        function generateCode() {
            return Math.floor(1000 + Math.random() * 9000).toString();
        }

        async function addCustomer() {
            if (!newCustomer.name || !newCustomer.phone) {
                alert('Please fill in name and phone');
                return;
            }

            try {
                const customerRef = push(ref(database, 'customers'));
                await set(customerRef, {
                    name: newCustomer.name,
                    phone: newCustomer.phone,
                    address: newCustomer.address,
                    washes: []
                });

                newCustomer = { name: '', phone: '', address: '' };
                await loadData();
                currentView = 'customers';
                render();
            } catch (err) {
                console.error('Error adding customer:', err);
                alert('Failed to add customer');
            }
        }

        async function addWash(customerId) {
            if (!newWash.washNumber) {
                alert('Please enter wash number');
                return;
            }

            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            const wash = {
                washNumber: parseInt(newWash.washNumber),
                status: newWash.status,
                pickupDate: newWash.pickupDate || null,
                deliveryDate: newWash.deliveryDate || null,
                pickupCode: newWash.status !== 'pending' ? (newWash.pickupCode || generateCode()) : null,
                deliveryCode: newWash.status === 'delivered' ? (newWash.deliveryCode || generateCode()) : null
            };

            const updatedWashes = [...(customer.washes || []), wash];

            try {
                await update(ref(database, `customers/${customerId}`), {
                    washes: updatedWashes
                });

                newWash = { washNumber: '', pickupDate: '', deliveryDate: '', pickupCode: '', deliveryCode: '', status: 'pending' };
                await loadData();
                render();
            } catch (err) {
                console.error('Error adding wash:', err);
                alert('Failed to add wash');
            }
        }

        async function updateWashStatus(customerId, washIndex, newStatus) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;

            const wash = customer.washes[washIndex];
            wash.status = newStatus;

            if (newStatus === 'picked-up' && !wash.pickupCode) {
                wash.pickupCode = generateCode();
                wash.pickupDate = new Date().toISOString();
            }

            if (newStatus === 'delivered' && !wash.deliveryCode) {
                wash.deliveryCode = generateCode();
                wash.deliveryDate = new Date().toISOString();
            }

            try {
                await update(ref(database, `customers/${customerId}`), {
                    washes: customer.washes
                });

                await loadData();
                render();
            } catch (err) {
                console.error('Error updating status:', err);
                alert('Failed to update status');
            }
        }

        function render() {
            const app = document.getElementById('app');
            
            app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-purple-50 to-indigo-50">
                    <!-- Header -->
                    <header class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white shadow-lg">
                        <div class="container mx-auto px-4 py-6">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="bg-white rounded-full w-12 h-12 flex items-center justify-center">
                                        <span class="text-2xl">üêÑüíú</span>
                                    </div>
                                    <div>
                                        <h1 class="text-2xl font-bold">Purple Cow Laundry</h1>
                                        <p class="text-purple-200 text-sm">Admin Portal</p>
                                    </div>
                                </div>
                                <button onclick="window.logout()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition">
                                    üö™ Logout
                                </button>
                            </div>
                        </div>
                    </header>

                    <!-- Navigation -->
                    <nav class="bg-white shadow-md">
                        <div class="container mx-auto px-4">
                            <div class="flex gap-1">
                                <button onclick="window.changeView('dashboard')" class="${currentView === 'dashboard' ? 'bg-purple-100 text-purple-600 border-b-2 border-purple-600' : 'text-gray-600 hover:bg-gray-50'} px-6 py-4 font-medium transition">
                                    üìä Dashboard
                                </button>
                                <button onclick="window.changeView('customers')" class="${currentView === 'customers' ? 'bg-purple-100 text-purple-600 border-b-2 border-purple-600' : 'text-gray-600 hover:bg-gray-50'} px-6 py-4 font-medium transition">
                                    üë• Customers
                                </button>
                                <button onclick="window.changeView('orders')" class="${currentView === 'orders' ? 'bg-purple-100 text-purple-600 border-b-2 border-purple-600' : 'text-gray-600 hover:bg-gray-50'} px-6 py-4 font-medium transition">
                                    üì¶ All Orders
                                </button>
                            </div>
                        </div>
                    </nav>

                    <!-- Main Content -->
                    <main class="container mx-auto px-4 py-8">
                        ${currentView === 'dashboard' ? renderDashboard() : ''}
                        ${currentView === 'customers' ? renderCustomers() : ''}
                        ${currentView === 'orders' ? renderOrders() : ''}
                    </main>
                </div>
            `;

            attachEventListeners();
        }

        function renderDashboard() {
            return `
                <div class="animate-slideIn">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Dashboard Overview</h2>
                    
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium">Total Orders</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-1">${stats.total}</p>
                                </div>
                                <div class="text-4xl">üì¶</div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-yellow-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium">Pending Pickup</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-1">${stats.pending}</p>
                                </div>
                                <div class="text-4xl">‚è∞</div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-purple-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium">In Process</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-1">${stats.pickedUp}</p>
                                </div>
                                <div class="text-4xl">üöö</div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-600 text-sm font-medium">Delivered</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-1">${stats.delivered}</p>
                                </div>
                                <div class="text-4xl">‚úÖ</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Quick Actions</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button onclick="window.changeView('customers')" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white px-6 py-4 rounded-lg font-semibold shadow-lg transition">
                                ‚ûï Add New Customer
                            </button>
                            <button onclick="window.changeView('orders')" class="bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white px-6 py-4 rounded-lg font-semibold shadow-lg transition">
                                üìã View All Orders
                            </button>
                            <button onclick="window.changeView('customers')" class="bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 text-white px-6 py-4 rounded-lg font-semibold shadow-lg transition">
                                üë• Manage Customers
                            </button>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Recent Orders</h3>
                        <div class="space-y-3">
                            ${customers.slice(0, 5).map(customer => 
                                customer.washes.slice(-1).map(wash => `
                                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="font-semibold text-gray-800">${customer.name}</p>
                                            <p class="text-sm text-gray-600">Wash #${wash.washNumber} - ${wash.status}</p>
                                        </div>
                                        <span class="px-3 py-1 rounded-full text-sm font-semibold ${
                                            wash.status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                                            wash.status === 'picked-up' ? 'bg-blue-100 text-blue-700' :
                                            'bg-green-100 text-green-700'
                                        }">${wash.status}</span>
                                    </div>
                                `).join('')
                            ).join('') || '<p class="text-gray-500 text-center py-8">No recent orders</p>'}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCustomers() {
            return `
                <div class="animate-slideIn">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Customer Management</h2>
                        <button onclick="window.toggleAddCustomer()" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white px-6 py-3 rounded-lg font-semibold shadow-lg transition">
                            ‚ûï Add New Customer
                        </button>
                    </div>

                    <!-- Add Customer Form -->
                    <div id="addCustomerForm" class="hidden bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Add New Customer</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <input type="text" id="customerName" placeholder="Customer Name *" class="px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <input type="tel" id="customerPhone" placeholder="Phone Number *" class="px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <input type="text" id="customerAddress" placeholder="Address (Optional)" class="px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div class="flex gap-3">
                            <button onclick="window.saveCustomer()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-semibold transition">
                                üíæ Save Customer
                            </button>
                            <button onclick="window.toggleAddCustomer()" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-lg font-semibold transition">
                                Cancel
                            </button>
                        </div>
                    </div>

                    <!-- Customers List -->
                    <div class="grid grid-cols-1 gap-4">
                        ${customers.map(customer => `
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <div class="flex items-start justify-between mb-4">
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-800">${customer.name}</h3>
                                        <p class="text-gray-600">üìû ${customer.phone}</p>
                                        ${customer.address ? `<p class="text-gray-600">üìç ${customer.address}</p>` : ''}
                                    </div>
                                    <button onclick="window.toggleAddWash('${customer.id}')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm font-semibold transition">
                                        ‚ûï Add Wash
                                    </button>
                                </div>

                                <!-- Add Wash Form -->
                                <div id="addWashForm-${customer.id}" class="hidden bg-purple-50 rounded-lg p-4 mb-4 border-2 border-purple-200">
                                    <h4 class="font-bold text-gray-800 mb-3">Add New Wash</h4>
                                    <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
                                        <input type="number" id="washNumber-${customer.id}" placeholder="Wash #" min="1" max="10" class="px-3 py-2 border rounded-lg">
                                        <select id="washStatus-${customer.id}" class="px-3 py-2 border rounded-lg">
                                            <option value="pending">Pending</option>
                                            <option value="picked-up">Picked Up</option>
                                            <option value="delivered">Delivered</option>
                                        </select>
                                        <input type="date" id="pickupDate-${customer.id}" placeholder="Pickup Date" class="px-3 py-2 border rounded-lg">
                                        <input type="date" id="deliveryDate-${customer.id}" placeholder="Delivery Date" class="px-3 py-2 border rounded-lg">
                                        <button onclick="window.saveWash('${customer.id}')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-semibold">
                                            Save
                                        </button>
                                        <button onclick="window.toggleAddWash('${customer.id}')" class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg text-sm font-semibold">
                                            Cancel
                                        </button>
                                    </div>
                                </div>

                                <!-- Washes -->
                                <div class="space-y-2">
                                    <h4 class="font-semibold text-gray-700">Wash History (${customer.washes.length}/10)</h4>
                                    ${customer.washes.length > 0 ? customer.washes.map((wash, index) => `
                                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                            <div class="flex-1">
                                                <span class="font-semibold text-gray-800">Wash #${wash.washNumber}</span>
                                                <span class="mx-2">‚Ä¢</span>
                                                ${wash.pickupCode ? `<span class="text-blue-600 font-mono">Pickup: #${wash.pickupCode}</span>` : ''}
                                                ${wash.deliveryCode ? `<span class="text-green-600 font-mono ml-2">Delivery: #${wash.deliveryCode}</span>` : ''}
                                            </div>
                                            <select onchange="window.updateStatus('${customer.id}', ${index}, this.value)" class="px-3 py-1 border rounded-lg text-sm ${
                                                wash.status === 'pending' ? 'bg-yellow-100 border-yellow-300' :
                                                wash.status === 'picked-up' ? 'bg-blue-100 border-blue-300' :
                                                'bg-green-100 border-green-300'
                                            }">
                                                <option value="pending" ${wash.status === 'pending' ? 'selected' : ''}>‚è∞ Pending</option>
                                                <option value="picked-up" ${wash.status === 'picked-up' ? 'selected' : ''}>üöö Picked Up</option>
                                                <option value="delivered" ${wash.status === 'delivered' ? 'selected' : ''}>‚úÖ Delivered</option>
                                            </select>
                                        </div>
                                    `).join('') : '<p class="text-gray-500 text-center py-4">No washes yet</p>'}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${customers.length === 0 ? '<p class="text-center text-gray-500 py-12 bg-white rounded-xl">No customers yet. Add your first customer!</p>' : ''}
                </div>
            `;
        }

        function renderOrders() {
            const allOrders = [];
            customers.forEach(customer => {
                customer.washes.forEach(wash => {
                    allOrders.push({ ...wash, customer });
                });
            });

            return `
                <div class="animate-slideIn">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">All Orders</h2>
                    
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-purple-600 text-white">
                                <tr>
                                    <th class="px-6 py-4 text-left">Customer</th>
                                    <th class="px-6 py-4 text-left">Wash #</th>
                                    <th class="px-6 py-4 text-left">Status</th>
                                    <th class="px-6 py-4 text-left">Pickup Code</th>
                                    <th class="px-6 py-4 text-left">Delivery Code</th>
                                    <th class="px-6 py-4 text-left">Pickup Date</th>
                                    <th class="px-6 py-4 text-left">Delivery Date</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                ${allOrders.map(order => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="px-6 py-4">
                                            <div class="font-semibold text-gray-800">${order.customer.name}</div>
                                            <div class="text-sm text-gray-600">${order.customer.phone}</div>
                                        </td>
                                        <td class="px-6 py-4 font-semibold">#${order.washNumber}</td>
                                        <td class="px-6 py-4">
                                            <span class="px-3 py-1 rounded-full text-sm font-semibold ${
                                                order.status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                                                order.status === 'picked-up' ? 'bg-blue-100 text-blue-700' :
                                                'bg-green-100 text-green-700'
                                            }">
                                                ${order.status === 'pending' ? '‚è∞ Pending' :
                                                  order.status === 'picked-up' ? 'üöö Picked Up' :
                                                  '‚úÖ Delivered'}
                                            </span>
                                        </td>
                                        <td class="px-6 py-4">
                                            ${order.pickupCode ? `<span class="font-mono text-blue-600 font-semibold">#${order.pickupCode}</span>` : '-'}
                                        </td>
                                        <td class="px-6 py-4">
                                            ${order.deliveryCode ? `<span class="font-mono text-green-600 font-semibold">#${order.deliveryCode}</span>` : '-'}
                                        </td>
                                        <td class="px-6 py-4 text-sm text-gray-600">
                                            ${order.pickupDate ? new Date(order.pickupDate).toLocaleDateString() : '-'}
                                        </td>
                                        <td class="px-6 py-4 text-sm text-gray-600">
                                            ${order.deliveryDate ? new Date(order.deliveryDate).toLocaleDateString() : '-'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${allOrders.length === 0 ? '<p class="text-center text-gray-500 py-12">No orders yet</p>' : ''}
                    </div>
                </div>
            `;
        }

        function attachEventListeners() {
            // Expose functions globally
            window.changeView = (view) => {
                currentView = view;
                render();
            };

            window.toggleAddCustomer = () => {
                const form = document.getElementById('addCustomerForm');
                form.classList.toggle('hidden');
            };

            window.toggleAddWash = (customerId) => {
                const form = document.getElementById(`addWashForm-${customerId}`);
                form.classList.toggle('hidden');
            };

            window.saveCustomer = () => {
                newCustomer.name = document.getElementById('customerName').value;
                newCustomer.phone = document.getElementById('customerPhone').value;
                newCustomer.address = document.getElementById('customerAddress').value;
                addCustomer();
            };

            window.saveWash = (customerId) => {
                newWash.washNumber = document.getElementById(`washNumber-${customerId}`).value;
                newWash.status = document.getElementById(`washStatus-${customerId}`).value;
                newWash.pickupDate = document.getElementById(`pickupDate-${customerId}`).value;
                newWash.deliveryDate = document.getElementById(`deliveryDate-${customerId}`).value;
                addWash(customerId);
            };

            window.updateStatus = (customerId, washIndex, newStatus) => {
                updateWashStatus(customerId, washIndex, newStatus);
            };

            window.logout = () => {
                if (confirm('Are you sure you want to logout?')) {
                    alert('Logout functionality - redirect to login page');
                }
            };
        }
    </script>
</body>
</html>
