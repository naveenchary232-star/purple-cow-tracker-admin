<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Purple Cow Laundry - Ultra Modern Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Updated Firebase CDN -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    body { background: linear-gradient(180deg, #0f1724 0%, #0b1020 60%); }
    .glass { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
    .accent { background: linear-gradient(90deg,#7c3aed,#6d28d9); }
    .glass-border { box-shadow: 0 6px 18px rgba(99,102,241,0.12); border: 1px solid rgba(255,255,255,0.04); }
    .drawer { transform: translateX(110%); transition: transform .35s cubic-bezier(.2,.9,.2,1); }
    .drawer.show { transform: translateX(0%); }
    @keyframes small-bounce {
      0%, 100% { transform: translateY(-6%); }
      50% { transform: translateY(0); }
    }
    .small-bounce { animation: small-bounce 1.1s infinite; }
    @media print {
      body * { visibility: hidden; }
      #printable-runsheet, #printable-runsheet * { visibility: visible; }
      #printable-runsheet { position: absolute; left: 0; top: 0; width: 100%; }
    }
    .error-state { background: linear-gradient(90deg, #ef4444, #dc2626); }
  </style>
</head>
<body class="min-h-screen text-gray-100 font-sans">

  <div id="root" class="p-6"></div>

  <script>
  const firebaseConfig = {
    apiKey: "AIzaSyCorv41Qlud5cK4_dvABePg6boVAr8vEJU",
    authDomain: "purple-cow-admin-2232f.firebaseapp.com",
    databaseURL: "https://purple-cow-admin-2232f-default-rtdb.firebaseio.com",
    projectId: "purple-cow-admin-2232f",
    storageBucket: "purple-cow-admin-2232f.firebasestorage.app",
    messagingSenderId: "295566586816",
    appId: "1:295566586816:web:358452d3998f2d78370e25",
    measurementId: "G-TE32V3BTHE"
  };

  const App = {
    customers: [],
    riders: [],
    runsheets: [],
    showAddCustomer: false,
    showAddRider: false,
    showCreateRunsheet: false,
    runsheetMode: false,
    showRunsheetDashboard: false,
    selectedRunsheet: null,
    selectedOrders: [],
    searchTerm: '',
    loading: true,
    firebaseError: null,
    copiedCode: null,
    saving: false,
    drawerCustomer: null,
    newCustomer: { name: '', phone: '', address: '', plan: '2699', startDate: new Date().toISOString().split('T')[0] },
    newRider: { name: '', phone: '', vehicle: '' },
    runsheetData: { riderId: '', type: 'pickup', date: new Date().toISOString().split('T')[0] },
    currentRunsheet: null,
    db: null,
    firebaseReady: false
  };

  window.onerror = function(msg) {
    console.error('Global error:', msg);
    App.firebaseError = msg.includes('firebase') ? 'Firebase connection failed - using offline mode' : msg;
    App.loading = false;
    App.render();
    return false;
  };

  async function initFirebase() {
    try {
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      App.db = firebase.firestore();
      try {
        await App.db.collection('customers').limit(1).get();
        console.log('‚úÖ Firebase + Firestore ready');
        App.firebaseReady = true;
        return true;
      } catch {
        console.warn('‚ö†Ô∏è Firestore read denied (rules?), continuing offline');
        App.firebaseReady = false;
        return true;
      }
    } catch (err) {
      console.error('‚ùå Firebase init failed:', err.message);
      App.firebaseError = `Firebase failed: ${err.message}. Using offline mode.`;
      App.firebaseReady = false;
      return false;
    }
  }

  App.init = async function() {
    const firebaseOk = await initFirebase();
    if (firebaseOk && App.firebaseReady) {
      try {
        await Promise.all([this.loadCustomers(), this.loadRiders(), this.loadRunsheets()]);
      } catch {
        this.customers = this.riders = this.runsheets = [];
      }
    } else {
      this.customers = this.riders = this.runsheets = [];
    }
    this.loading = false;
    this.render();
  };

  App.loadCustomers = async function() {
    if (!App.db) return;
    try {
      const snapshot = await App.db.collection('customers').orderBy('startDate','desc').get();
      this.customers = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    } catch {
      this.customers = [];
    }
  };

  App.loadRiders = async function() {
    if (!App.db) return;
    try {
      const snapshot = await App.db.collection('riders').orderBy('createdAt','desc').get();
      this.riders = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    } catch {
      this.riders = [];
    }
  };

  App.loadRunsheets = async function() {
    if (!App.db) return;
    try {
      const snapshot = await App.db.collection('runsheets').orderBy('createdAt','desc').get();
      this.runsheets = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    } catch {
      this.runsheets = [];
    }
  };

  App.addCustomer = async function() {
    if (!this.newCustomer.name || !this.newCustomer.phone) { alert('Enter name and phone'); return; }
    if (!App.db) { alert('No database connection.'); return; }
    this.saving = true; this.render();
    const customer = {
      name: this.newCustomer.name.trim(),
      phone: this.newCustomer.phone.trim(),
      address: (this.newCustomer.address || '').trim(),
      plan: this.newCustomer.plan,
      startDate: this.newCustomer.startDate,
      washes: Array(10).fill(null).map((_,i) => ({
        washNumber: i+1, status: 'pending', pickupDate: null, deliveryDate: null, pickupCode: null, deliveryCode: null
      })),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    try {
      const ref = await App.db.collection('customers').add(customer);
      this.customers.unshift({ id: ref.id, ...customer });
      this.newCustomer = { name: '', phone: '', address: '', plan: '2699', startDate: new Date().toISOString().split('T')[0] };
      this.showAddCustomer = false; this.saving = false; this.render();
      alert('‚úÖ Customer added');
    } catch (err) {
      this.saving = false; this.render(); alert('Failed: ' + err.message);
    }
  };

  App.addRider = async function() {
    if (!this.newRider.name || !this.newRider.phone) { alert('Enter rider name and phone'); return; }
    if (!App.db) { alert('No database connection.'); return; }
    this.saving = true; this.render();
    const rider = { name: this.newRider.name.trim(), phone: this.newRider.phone.trim(), vehicle: (this.newRider.vehicle||'').trim(), createdAt: firebase.firestore.FieldValue.serverTimestamp() };
    try {
      const ref = await App.db.collection('riders').add(rider);
      this.riders.unshift({ id: ref.id, ...rider });
      this.newRider = { name: '', phone: '', vehicle: '' }; this.showAddRider = false; this.saving = false; this.render();
      alert('‚úÖ Rider added');
    } catch (err) {
      this.saving = false; this.render(); alert('Failed: ' + err.message);
    }
  };

  App.toggleOrderSelection = function(customerId, washNumber) {
    const key = `${customerId}-${washNumber}`;
    const idx = this.selectedOrders.findIndex(o => o.key === key);
    if (idx > -1) { this.selectedOrders.splice(idx,1); this.render(); return; }
    const customer = this.customers.find(c => c.id === customerId);
    if (!customer) return;
    const wash = customer.washes.find(w => w.washNumber === washNumber);
    this.selectedOrders.push({
      key, customerId, washNumber,
      customerName: customer.name, customerPhone: customer.phone, customerAddress: customer.address,
      status: wash.status, pickupCode: wash.pickupCode || null
    });
    this.render();
  };

  App.isOrderSelected = function(customerId, washNumber) {
    return this.selectedOrders.some(o => o.key === `${customerId}-${washNumber}`);
  };

  App.createRunsheet = async function() {
    if (!this.runsheetData.riderId) return alert('Select a rider');
    if (this.selectedOrders.length === 0) return alert('Select orders');
    if (!App.db) { alert('No database connection.'); return; }
    this.saving = true; this.render();

    const rider = this.riders.find(r => r.id === this.runsheetData.riderId);
    const runsheetId = `RS${Date.now()}`;
    const runsheet = {
      runsheetId,
      riderId: this.runsheetData.riderId,
      riderName: rider.name, riderPhone: rider.phone, riderVehicle: rider.vehicle || null,
      type: this.runsheetData.type, date: this.runsheetData.date,
      orders: this.selectedOrders.map(o => ({ ...o, completed: false })),
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      status: 'active'
    };

    const batch = App.db.batch();
    const runsheetRef = App.db.collection('runsheets').doc(runsheetId);
    batch.set(runsheetRef, runsheet);
    this.selectedOrders.forEach(order => {
      const custRef = App.db.collection('customers').doc(order.customerId);
      batch.update(custRef, { [`washes.${order.washNumber - 1}.status`]: 'ofd' });
    });

    try {
      await batch.commit();
      this.runsheets.unshift(runsheet);
      this.currentRunsheet = runsheet;
      this.selectedOrders = [];
      this.saving = false;
      if (App.firebaseReady) await this.loadCustomers();
      this.render();
      setTimeout(() => window.print(), 600);
    } catch (err) {
      this.saving = false; this.render(); alert('Failed: ' + err.message);
    }
  };

  // Other unchanged methods (closeRunsheet, ...)

  App.getFilteredCustomers = function() {
    return this.customers.filter(c => (c.name||'').toLowerCase().includes(this.searchTerm.toLowerCase()) || (c.phone||'').includes(this.searchTerm));
  };

  App.render = function() {
    const root = document.getElementById('root');
    const customers = this.getFilteredCustomers();

    if (this.currentRunsheet) {
      root.innerHTML = `
        <div class="min-h-screen p-8">
          <div id="printable-runsheet" class="max-w-4xl mx-auto bg-white p-8 rounded-lg">
            <div class="text-center pb-4 mb-6 border-b-4 border-purple-600">
              <h1 class="text-3xl font-bold text-purple-600">üêÑ PURPLE COW LAUNDRY</h1>
              <p class="text-gray-600 mt-1">Delivery Runsheet</p>
            </div>
            <div class="grid grid-cols-2 gap-4 mb-6">
              <div>
                <p><strong>ID:</strong> ${this.currentRunsheet.runsheetId}</p>
                <p><strong>Type:</strong> ${this.currentRunsheet.type}</p>
                <p><strong>Date:</strong> ${this.currentRunsheet.date}</p>
                <p><strong>Orders:</strong> ${this.currentRunsheet.orders.length}</p>
              </div>
              <div>
                <p><strong>Rider:</strong> ${this.currentRunsheet.riderName}</p>
                <p><strong>Phone:</strong> ${this.currentRunsheet.riderPhone}</p>
                <p><strong>Vehicle:</strong> ${this.currentRunsheet.riderVehicle || 'N/A'}</p>
              </div>
            </div>
            <table class="w-full border-collapse border border-gray-300 mb-6">
              <thead><tr class="bg-purple-100"><th class="border px-2 py-2 text-left">#</th><th class="border px-2 py-2 text-left">Customer</th><th class="border px-2 py-2 text-left">Phone</th><th class="border px-2 py-2 text-left">Address</th><th class="border px-2 py-2 text-left">Wash</th><th class="border px-2 py-2 text-left">Order ID</th><th class="border px-2 py-2 text-left">Signature</th></tr></thead>
              <tbody>
                ${this.currentRunsheet.orders.map((o,i) => `<tr><td class="border px-2 py-2">${i+1}</td><td class="border px-2 py-2">${o.customerName}</td><td class="border px-2 py-2">${o.customerPhone}</td><td class="border px-2 py-2">${o.customerAddress || 'N/A'}</td><td class="border px-2 py-2">${o.washNumber}</td><td class="border px-2 py-2 font-bold">#${o.pickupCode || 'N/A'}</td><td class="border px-2 py-2"></td></tr>`).join('')}
              </tbody>
            </table>
            <div class="grid grid-cols-2 gap-6 mt-8 pt-6 border-t border-gray-300">
              <div><p class="font-bold mb-2">Rider Signature:</p><div class="border-b-2 border-gray-400 h-16"></div></div>
              <div><p class="font-bold mb-2">Manager Signature:</p><div class="border-b-2 border-gray-400 h-16"></div></div>
            </div>
            <div class="mt-6 text-center text-sm text-gray-600">
              <p>Generated: ${new Date().toLocaleString('en-IN')}</p>
              <p>Purple Cow Laundry</p>
            </div>
          </div>
          <div class="max-w-4xl mx-auto mt-6 flex gap-3 justify-center print:hidden">
            <button onclick="window.print()" class="px-5 py-2 rounded bg-purple-600 hover:bg-purple-700">üñ® Print</button>
            <button onclick="App.closeRunsheet()" class="px-5 py-2 rounded bg-gray-700 hover:bg-gray-600">Close</button>
          </div>
        </div>
      `;
      return;
    }

    root.innerHTML = `
      <div class="max-w-7xl mx-auto">
        <div class="flex items-center justify-between gap-4 mb-6">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-full accent flex items-center justify-center text-white text-xl font-bold small-bounce shadow-lg">üêÑ</div>
            <div>
              <h1 class="text-2xl font-bold">Purple Cow Laundry</h1>
              <div class="text-sm text-gray-400">Ultra Modern Dashboard ‚Ä¢ 10-wash plans</div>
            </div>
          </div>
          <div class="flex gap-3">
            <button onclick="App.openRunsheetDashboard()" class="px-4 py-2 rounded bg-indigo-500 hover:bg-indigo-600">üìä Runsheets</button>
            <button onclick="App.showAddRider = !App.showAddRider; App.showAddCustomer = false; App.showCreateRunsheet = false; App.render();" class="px-4 py-2 rounded bg-yellow-600 hover:bg-yellow-700">üèç Add Rider</button>
            <button onclick="App.runsheetMode = !App.runsheetMode; App.showCreateRunsheet = App.runsheetMode; App.showAddCustomer = App.showAddRider = false; if(!App.runsheetMode) App.selectedOrders = []; App.render();" class="px-4 py-2 rounded ${this.runsheetMode ? 'bg-orange-600' : 'bg-blue-600'} hover:opacity-95">${this.runsheetMode ? 'Cancel' : 'Create Runsheet'}</button>
            <button onclick="App.showAddCustomer = !App.showAddCustomer; App.showAddRider = App.showCreateRunsheet = false; App.render();" class="px-4 py-2 rounded bg-purple-600 hover:bg-purple-700">Ôºã Add Customer</button>
          </div>
        </div>
        ${this.firebaseError ? `
          <div class="error-state p-4 rounded-lg mb-6 text-white flex items-center gap-3">
            <span class="text-xl">‚ö†Ô∏è</span>
            <div>
              <div class="font-bold">${this.firebaseError}</div>
              <div class="text-sm mt-1">Dashboard works offline - Add customers and riders to start!</div>
            </div>
            <button onclick="App.firebaseError=null; App.init();" class="ml-auto px-4 py-2 bg-white text-red-600 rounded hover:bg-gray-100">Retry</button>
          </div>
        ` : ''}
        ${this.copiedCode ? `<div class="fixed right-6 top-6 bg-green-500 text-white px-4 py-2 rounded shadow-lg">Copied #${this.copiedCode}</div>` : ''}
        <!-- Add your customer and rider forms and lists here (omitted for brevity) -->
      </div>
    `;

    setTimeout(() => {
      const el = document.querySelector('.drawer');
      if (App.drawerCustomer && el) el.classList.add('show');
      if (!App.drawerCustomer && el) el.classList.remove('show');
    }, 50);
  };

  App.init();

  window.App = App;
  </script>
</body>
</html>
